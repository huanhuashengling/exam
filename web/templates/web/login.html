{% extends '../base.html' %}
{% block title %}首页{% endblock %}
{% block content %}
<div class="container" style="padding-top: 20px;">
  <div class="row justify-content-center">
      <form class="form-signin">
        <h5>请登录</h5>
        <div class="form-group">
          <label for="signInId" class="sr-only">电话号码</label>
          <input type="email" id="signInId" class="form-control" placeholder="11位手机号" required="" autofocus="" value="">
        </div>

        <div class="form-group">
          <label for="signInPassword" class="sr-only">密码</label>
          <input type="password" id="signInPassword" class="form-control" placeholder="输入密码" required="" value="">
        </div>

        <div class="form-group">
          <label for="signInVcode" class="sr-only">验证码</label>
          <img id="signInVcodeImg" src="" style="height: 50px;width: 150px;" />
          <input type="text" class="form-control" id="signInVcode" placeholder="">
        </div>
        
        <div class="form-group">
          <button type="button" class="btn btn-default btn-sm" id="gotoSignUp">没有账户，去注册</button>
          <button type="button" class="btn btn-primary" id="signInPost">登录</button>
        </div>
      </form>
    </div>
</div>
{% endblock %}
{% block js %}
    <script type="text/javascript">
        $.ajaxSetup({
            data: {csrfmiddlewaretoken: '{{ csrf_token }}' }
        });
        var loginSign;
        refreshVcode();
        $('#signInVcodeImg').click(function () {
            refreshVcode();
        });

        $('#gotoSignUp').click(function () {
            window.location.href = '/signup';
        });

        $('#signInPost').click(function () {
            var phone = $('#signInId').val();
            var password = $('#signInPassword').val();
            var vcode = $('#signInVcode').val();
            // if(!checkEmail(phone)){
            //     $('#signInId').val('');
            //     $('#signInId').attr('placeholder', '邮件格式错误');
            //     $('#signInId').css('border', '1px solid red');
            //     return false;
            // }else{
            //     $('#signInId').css('border', '1px solid #C1FFC1');
            // }
            if(!password){
                $('#signInPassword').attr('placeholder', '请填写密码');
                $('#signInPassword').css('border', '1px solid red');
            }else{
                $('#signInPassword').css('border', '1px solid #C1FFC1');
            }
            $.ajax({
                url: '/api/login_normal',
                data: {
                    'phone': phone,
                    'password': password,
                    'sign': loginSign,
                    'vcode': vcode
                },
                type: 'post',
                dataType: 'json',
                success: function(res){
                    if (res.status === 200){
                        window.location.href = '/index';
                    } else if(res.status === 300001) {
                        refreshVcode();
                        alert('用户名错误');
                    } else if(res.status === 300002) {
                        refreshVcode();
                        alert('密码错误');
                    } else if(res.status === 300003) {
                        refreshVcode();
                        alert('验证码错误');
                    } else {
                        refreshVcode();
                        alert('登录错误');
                    }
                }
            })
        });

      function refreshVcode() {
          $.ajax({
              url: '/api/login_vcode',
              data: {},
              dataType: 'json',
              type: 'get',
              success: function (res) {
                  if (res.status === 200) {
                      loginSign = res.data.sign;
                      $('#signInVcodeImg').attr('src', "data:image/png;base64," + res.data.vcode);
                  }
              }
          });
      }
    </script>
{% endblock %}